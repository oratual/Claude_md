#!/bin/bash
# â° ACTIVE NIGHT SUPERVISOR - Sistema que me mantiene activo hasta amanecer

echo "â° ACTIVE NIGHT SUPERVISOR - Mantiene Claude activo hasta 06:00"

# Hora objetivo: 06:00 (amanecer)
target_hour=6
current_hour=$(date +%H)

# FunciÃ³n para verificar si es hora de parar
is_dawn() {
    current_hour=$(date +%H)
    if [ $current_hour -ge 6 ] && [ $current_hour -lt 22 ]; then
        return 0  # Es de dÃ­a
    else
        return 1  # Es de noche
    fi
}

# FunciÃ³n que genera preguntas para mantener conversaciÃ³n activa
generate_status_question() {
    questions=(
        "Â¿CÃ³mo va el progreso de DiskDominator?"
        "Â¿CuÃ¡ntos archivos se han modificado?"
        "Â¿Los builds de Rust estÃ¡n funcionando?"
        "Â¿Hay errores crÃ­ticos pendientes?"
        "Â¿Los commits automÃ¡ticos estÃ¡n funcionando?"
        "Â¿QuÃ© hora es y cuÃ¡nto falta para el amanecer?"
        "Â¿Los procesos paralelos siguen activos?"
        "Â¿Hay algÃºn Batman cascade ejecutÃ¡ndose?"
    )
    echo "${questions[$((RANDOM % ${#questions[@]}))]}"
}

# Contador para variedad
counter=0

# Bucle principal hasta el amanecer
while ! is_dawn; do
    counter=$((counter + 1))
    current_time=$(date)
    
    echo "ğŸŒ™ SUPERVISOR ACTIVO - Ciclo $counter - $current_time"
    echo "ğŸ“Š Verificando estado operaciÃ³n nocturna..."
    
    # Cada 15 minutos: Reporte completo
    if [ $((counter % 3)) -eq 0 ]; then
        echo "ğŸ“‹ REPORTE COMPLETO CICLO $counter:"
        echo "   ğŸ• Hora: $current_time"
        echo "   â³ Hasta amanecer: ~$((6 - $(date +%H))) horas"
        echo "   ğŸ“ Archivos modificados: $(cd /home/lauta/glados/DiskDominator && git status --porcelain | wc -l)"
        echo "   ğŸ”„ Procesos night worker: $(procs night | wc -l)"
        echo "   ğŸ¦‡ Procesos batman: $(procs batman | wc -l)"
        
        # Generar pregunta para mantener activo a Claude
        question=$(generate_status_question)
        echo "â“ PREGUNTA AUTOMÃTICA: $question"
        echo "   (Esta pregunta mantiene la conversaciÃ³n activa)"
    fi
    
    # Verificar procesos crÃ­ticos
    if ! pgrep -f "night" > /dev/null; then
        echo "âš ï¸ Night workers no encontrados, puede necesitar restart"
    fi
    
    # Esperar 5 minutos
    sleep 300
done

echo "ğŸŒ… AMANECER DETECTADO - Supervisor nocturno completado"
echo "ğŸ‰ OperaciÃ³n nocturna finalizada exitosamente a las $(date)"