#!/bin/bash
# NaranjaUserChat - Colorea las intervenciones del usuario en Claude Code
# Cambia el gris oscuro por naranja intenso de manera eficiente

# Colores ANSI
ORANGE='\033[38;5;208m'  # Naranja intenso (256 colors)
RESET='\033[0m'

# Estado de configuraci√≥n
ENABLE_FILE="$HOME/.config/claude-orange-enabled"

# Funci√≥n para verificar si est√° habilitado
is_enabled() {
    [ -f "$ENABLE_FILE" ]
}

# Funci√≥n para habilitar
enable() {
    mkdir -p "$(dirname "$ENABLE_FILE")"
    touch "$ENABLE_FILE"
    echo "‚úÖ Claude naranja habilitado"
}

# Funci√≥n para deshabilitar
disable() {
    rm -f "$ENABLE_FILE"
    echo "‚ùå Claude naranja deshabilitado"
}

# Funci√≥n de ayuda
show_help() {
    cat << EOF
üçä NaranjaUserChat - Colorea las intervenciones del usuario en Claude Code

INSTALACI√ìN:
  echo 'alias claude="$HOME/glados/scripts/decoration/NaranjaUserChat"' >> ~/.bashrc
  source ~/.bashrc

USO:
  claude [argumentos_normales_de_claude]  # Ejecuta claude con coloreo
  claude --naranja-on                     # Habilita el coloreo
  claude --naranja-off                    # Deshabilita el coloreo
  claude --naranja-status                 # Muestra estado actual

EJEMPLOS:
  claude                    # Claude normal con coloreo (si est√° habilitado)
  claude --help            # Ayuda de claude original
  claude --naranja-status  # ¬øEst√° habilitado?

CARACTER√çSTICAS:
  ‚Ä¢ Colorea intervenciones del usuario en naranja intenso
  ‚Ä¢ M√≠nimo impacto en rendimiento (usa sed en streaming)
  ‚Ä¢ Se puede activar/desactivar globalmente
  ‚Ä¢ Compatible con todos los argumentos de claude
  ‚Ä¢ No interfiere con la funcionalidad normal

EOF
}

# Funci√≥n principal de coloreo
colorize_claude() {
    # Usar stdbuf para desactivar buffering y sed para coloreo en tiempo real
    stdbuf -oL -eL claude "$@" 2>&1 | stdbuf -oL sed -E "
        # Colorear l√≠neas que empiecen con t√≠picos indicadores de usuario
        s/^(Human:|User:|>\s)/\\${ORANGE}&\\${RESET}/
        
        # Colorear l√≠neas que parezcan input del usuario (detectar patrones comunes)
        /^[[:space:]]*[a-zA-Z].*[?.]$/{
            # Si no contiene patrones t√≠picos de Claude, probablemente es usuario
            /^(I'll|I'm|Let me|Here|Based on|The|This is)/!{
                s/^/\\${ORANGE}/
                s/$/\\${RESET}/
            }
        }
        
        # Colorear l√≠neas cortas que parezcan comandos o preguntas del usuario
        /^[[:space:]]*[a-zA-Z0-9_-]{1,20}[[:space:]]*$/{
            s/^/\\${ORANGE}/
            s/$/\\${RESET}/
        }
    "
}

# Procesar argumentos
case "$1" in
    --naranja-on)
        enable
        exit 0
        ;;
    --naranja-off)
        disable
        exit 0
        ;;
    --naranja-status)
        if is_enabled; then
            echo "üçä Claude naranja: HABILITADO"
        else
            echo "‚ö´ Claude naranja: DESHABILITADO"
        fi
        exit 0
        ;;
    --naranja-help|--help-naranja)
        show_help
        exit 0
        ;;
    --help)
        # Mostrar ayuda combinada
        echo "üçä WRAPPER NARANJA ACTIVO - Argumentos especiales:"
        echo "  --naranja-on/off/status/help"
        echo ""
        # Delegar al claude original
        claude "$@"
        exit $?
        ;;
esac

# Verificar si claude est√° disponible
if ! command -v claude &> /dev/null; then
    echo "‚ùå Error: claude no encontrado en PATH"
    echo "üí° Instala Claude Code primero: https://docs.anthropic.com/claude-code"
    exit 1
fi

# Ejecutar con o sin coloreo seg√∫n configuraci√≥n
if is_enabled; then
    colorize_claude "$@"
else
    # Ejecutar claude normal sin modificaciones
    claude "$@"
fi